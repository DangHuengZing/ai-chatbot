name: Deploy to Server

on:
  push:
    branches:
      - main  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.5.3
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} << 'EOF'
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ~/ai_project || exit
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ğŸ”„ æ­£åœ¨ä» GitHub æ‹‰å–æœ€æ–°ä»£ç ..."
          git reset --hard HEAD
          git pull origin main

          # æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹
          echo "ğŸ›‘ æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹..."
          PIDS=$(lsof -t -i:8001)
          if [ -n "$PIDS" ]; then
              kill -9 $PIDS
              echo "âœ… å·²å…³é—­è¿›ç¨‹: $PIDS"
          else
              echo "âœ… æ²¡æœ‰å ç”¨ç«¯å£çš„è¿›ç¨‹"
          fi

          # å¯åŠ¨ gunicorn åå°è¿è¡Œï¼Œä½¿ç”¨ sync worker æ¥ä¼˜åŒ–æµå¼è¾“å‡º
          echo "ğŸš€ å¯åŠ¨æ–°çš„ Gunicorn è¿›ç¨‹..."
          source ~/ai_project/venv/bin/activate
          nohup gunicorn ai_site.wsgi:application --bind 127.0.0.1:8001 --worker-class sync > gunicorn.log 2>&1 &
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼Gunicorn åå°è¿è¡Œä¸­ï¼æ—¥å¿—åœ¨ gunicorn.log"
        EOF
