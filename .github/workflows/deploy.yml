name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3 # Updated to v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0 # Updated to v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} << 'EOF'
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd ~/ai_project || exit
          
          # æ‹‰å–æœ€æ–°ä»£ç 
          echo "ðŸ”„ æ­£åœ¨ä»Ž GitHub æ‹‰å–æœ€æ–°ä»£ç ..."
          git reset --hard HEAD
          git pull origin main

          # æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹
          echo "ðŸ›‘ æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹..."
          PIDS=$(lsof -t -i:8001)
          if [ -n "$PIDS" ]; then
            echo "Killing PIDS: $PIDS"
            kill -9 $PIDS # Ensure PIDS is quoted
            echo "âœ… å·²å…³é—­è¿›ç¨‹: $PIDS"
          else
            echo "âœ… æ²¡æœ‰å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹"
          fi

          # å¯åŠ¨ gunicorn åŽå°è¿è¡Œ
          echo "ðŸš€ å¯åŠ¨æ–°çš„ Gunicorn è¿›ç¨‹..."
          source ~/ai_project/venv/bin/activate
          # æ˜Žç¡®è®¾ç½® --timeout (ä¾‹å¦‚ 180 ç§’) å’Œ --workers (ä¾‹å¦‚ 3)
          nohup gunicorn ai_site.wsgi:application \
              --bind 127.0.0.1:8001 \
              --workers 3 \
              --timeout 180 \
              --worker-class sync > gunicorn.log 2>&1 &
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼Gunicorn åŽå°è¿è¡Œä¸­ï¼æ—¥å¿—åœ¨ gunicorn.log"
          echo "Gunicorn command used: nohup gunicorn ai_site.wsgi:application --bind 127.0.0.1:8001 --workers 3 --timeout 180 --worker-class sync > gunicorn.log 2>&1 &"
        EOF
