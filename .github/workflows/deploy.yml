name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Server via SSH
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} << 'EOF'
          set -e
          
          echo "--- è¿›å…¥é¡¹ç›®ç›®å½• ---"
          cd ~/ai_project || { echo "âŒ é¡¹ç›®ç›®å½•ä¸å­˜åœ¨"; exit 1; }

          echo "--- æ‹‰å– Git æœ€æ–°ä»£ç  ---"
          git reset --hard HEAD
          git fetch origin
          git reset --hard origin/main

          echo "--- åœæ­¢ç°æœ‰ Gunicorn æœåŠ¡ï¼ˆæŸ¥ç«¯å£ 8001ï¼‰ ---"
          PIDS=$(lsof -t -i:8001 || true)
          if [ -n "$PIDS" ]; then
            echo "å‘ç°è¿›ç¨‹: $PIDSï¼Œæ‰§è¡Œ kill -9..."
            kill -9 $PIDS || echo "kill -9 å¤±è´¥æˆ–éƒ¨åˆ†å¤±è´¥"
            sleep 3
          else
            echo "âœ… æ— ç«¯å£å ç”¨"
          fi

          echo "--- å¯åŠ¨æ–°çš„ Gunicorn è¿›ç¨‹ ---"
          nohup gunicorn \
            --bind 127.0.0.1:8001 \
            --workers 3 \
            --timeout 180 \
            --worker-class sync \
            --log-level debug \
            --access-logfile /root/ai_project/gunicorn_access.log \
            --error-logfile /root/ai_project/gunicorn_error.log \
            ai_site.wsgi:application > /root/ai_project/gunicorn_stdout_stderr.log 2>&1 &

          sleep 3

          if lsof -Pi TCP:8001 -sTCP:LISTEN -t > /dev/null ; then
            echo "âœ… éƒ¨ç½²å®Œæˆï¼Gunicorn å¯åŠ¨æˆåŠŸï¼"
          else
            echo "âŒ Gunicorn å¯åŠ¨å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—ï¼š"
            echo "ğŸªµ stdout: /root/ai_project/gunicorn_stdout_stderr.log"
            echo "ğŸªµ error : /root/ai_project/gunicorn_error.log"
            exit 1
          fi
        EOF
