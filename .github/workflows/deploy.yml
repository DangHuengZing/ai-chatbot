name: Deploy to Server

on:
Â  push:
Â  Â  branches:
Â  Â  Â  - main

jobs:
Â  deploy:
Â  Â  runs-on: ubuntu-latest

Â  Â  steps:
Â  Â  - name: Checkout code
Â  Â  Â  uses: actions/checkout@v2

Â  Â  - name: Set up SSH
Â  Â  Â  uses: webfactory/ssh-agent@v0.5.3
Â  Â  Â  with:
Â  Â  Â  Â  ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

Â  Â  - name: Deploy to Server via SSH
Â  Â  Â  run: |
Â  Â  Â  Â  ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USERNAME }}@${{ secrets.SERVER_IP }} << 'EOF'
Â  Â  Â  Â  Â  # è¿›å…¥é¡¹ç›®ç›®å½•
Â  Â  Â  Â  Â  cd ~/ai_project || exit
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  # æ‹‰å–æœ€æ–°ä»£ç 
Â  Â  Â  Â  Â  echo "ğŸ”„ æ­£åœ¨ä» GitHub æ‹‰å–æœ€æ–°ä»£ç ..."
Â  Â  Â  Â  Â  git reset --hard HEAD
Â  Â  Â  Â  Â  git pull origin main

Â  Â  Â  Â  Â  # æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹
Â  Â  Â  Â  Â  echo "ğŸ›‘ æŸ¥æ‰¾å¹¶å…³é—­å ç”¨ç«¯å£ 8001 çš„è¿›ç¨‹..."
Â  Â  Â  Â  Â  PIDS=$(lsof -t -i:8001)
Â  Â  Â  Â  Â  if [ -n "$PIDS" ]; then
Â  Â  Â  Â  Â  Â  Â  kill -9 $PIDS
Â  Â  Â  Â  Â  Â  Â  echo "âœ… å·²å…³é—­è¿›ç¨‹: $PIDS"
Â  Â  Â  Â  Â  else
Â  Â  Â  Â  Â  Â  Â  echo "âœ… æ²¡æœ‰å ç”¨ç«¯å£çš„è¿›ç¨‹"
Â  Â  Â  Â  Â  fi

Â  Â  Â  Â  Â  # å¯åŠ¨ gunicorn åå°è¿è¡Œ
Â  Â  Â  Â  Â  echo "ğŸš€ å¯åŠ¨æ–°çš„ Gunicorn è¿›ç¨‹..."
Â  Â  Â  Â  Â  source ~/ai_project/venv/bin/activate
Â  Â  Â  Â  Â  # æ·»åŠ  --timeout å‚æ•°ï¼Œä¾‹å¦‚ 180 ç§’ (3åˆ†é’Ÿ)
Â  Â  Â  Â  Â  nohup gunicorn ai_site.wsgi:application --bind 127.0.0.1:8001 --worker-class sync --timeout 180 > gunicorn.log 2>&1 &
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  echo "âœ… éƒ¨ç½²å®Œæˆï¼Gunicorn åå°è¿è¡Œä¸­ï¼æ—¥å¿—åœ¨ gunicorn.log"
Â  Â  Â  Â  EOF
