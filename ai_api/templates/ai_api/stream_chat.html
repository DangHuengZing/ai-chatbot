<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>DeepSeek 智能助手</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f8fafc; margin: 0; padding: 2rem; }
    #chat-box { max-width: 800px; margin: auto; background: #fff; padding: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .message { margin: 1rem 0; padding: 0.8rem; border-left: 4px solid #4299e1; background: #f1f5f9; border-radius: 4px; }
    .ai { border-color: #48bb78; }
    textarea { width: 100%; padding: 0.8rem; border-radius: 6px; margin-top: 1rem; border: 1px solid #cbd5e0; }
    button { padding: 0.6rem 1.2rem; background: #4299e1; color: #fff; border: none; border-radius: 6px; margin-top: 0.5rem; }
    button:hover { background: #3182ce; }
  </style>
</head>
<body>
  <div id="chat-box"></div>

  <textarea id="input" placeholder="输入您的问题...(Shift+Enter换行)" onkeydown="handleKey(event)"></textarea>
  <br>
  <button onclick="send()">发送</button>

  <script>
    const chatBox = document.getElementById('chat-box');
    const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

    function appendMessage(text, role) {
      const div = document.createElement('div');
      div.className = 'message ' + (role === 'ai' ? 'ai' : '');
      div.innerText = text;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    function handleKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    }

    async function send() {
      const input = document.getElementById('input');
      const question = input.value.trim();
      if (!question) return;

      appendMessage(question, 'user');
      const aiMsg = document.createElement('div');
      aiMsg.className = 'message ai';
      aiMsg.innerText = '';
      chatBox.appendChild(aiMsg);
      chatBox.scrollTop = chatBox.scrollHeight;
      input.value = '';

      try {
        const controller = new AbortController();
        const response = await fetch('/chat/stream/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
          },
          body: JSON.stringify({ question }),
          signal: controller.signal
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let fullText = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value);
          const lines = chunk.split("\n\n").filter(l => l.trim());
          for (let line of lines) {
            if (line.startsWith('data: ')) {
              const data = JSON.parse(line.slice(6));
              if (data.error) {
                aiMsg.innerHTML = `<span style="color: red;">${data.error}</span>`;
                return;
              }
              fullText += data.content;
              aiMsg.innerText = fullText;
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          }
        }
      } catch (e) {
        aiMsg.innerHTML = `<span style="color: red;">出错了，请稍后重试。</span>`;
      }
    }
  </script>
</body>
</html>
