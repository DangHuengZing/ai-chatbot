<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>DeepSeek 智能助手</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
      background: #f8fafc;
    }
    #chat-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 1.5rem;
    }
    #chat-box {
      height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background: #f8fafc;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    .message {
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 8px;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .user-message { border-left: 4px solid #4299e1; }
    .ai-message { border-left: 4px solid #48bb78; }
    .message-header { display: flex; align-items: center; margin-bottom: 0.5rem; color: #4a5568; }
    .message-header strong { margin-right: 0.5rem; }
    .timestamp { font-size: 0.8rem; color: #718096; }
    textarea {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      resize: vertical;
      min-height: 80px;
    }
    button {
      background: #2b6cb0;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover { background: #2c5282; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .markdown-body { line-height: 1.6; }
    .model-selector {
      padding: 0.5rem;
      border: 2px solid #e2e8f0;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <h1>DeepSeek 智能助手</h1>
    <select class="model-selector" id="model-select">
      <option value="v3">通用聊天模型 (v3)</option>
      <option value="r1">代码助手 (r1)</option>
    </select>
    <div id="chat-box"></div>
    <textarea id="user-input" placeholder="输入您的问题...(Shift+Enter换行)" onkeydown="handleKeydown(event)"></textarea>
    <div style="text-align: right; margin-top: 1rem;">
      <button id="send-btn" onclick="sendMessage()">发送</button>
    </div>
  </div>

<script>
let controller = null;
const chatBox = document.getElementById('chat-box');
const sendBtn = document.getElementById('send-btn');

function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let i = 0; i < cookies.length; i++) {
      const cookie = cookies[i].trim();
      if (cookie.substring(0, name.length + 1) === (name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

function handleKeydown(event) {
  if (event.key === 'Enter' && !event.shiftKey) {
    event.preventDefault();
    sendMessage();
  }
}

async function sendMessage() {
  const input = document.getElementById('user-input');
  const question = input.value.trim();
  const model = document.getElementById('model-select').value;

  if (!question) {
    input.classList.add('error');
    return;
  }

  sendBtn.disabled = true;
  input.value = '';

  const userMsg = createMessageElement('user', question);
  chatBox.appendChild(userMsg);

  const aiMsg = createMessageElement('ai', '思考中...');
  chatBox.appendChild(aiMsg);
  scrollToBottom();

  const csrftoken = getCookie('csrftoken');
  controller = new AbortController();

  try {
    const response = await fetch('/chat/stream/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      credentials: 'same-origin',
      body: JSON.stringify({ question, model }),
      signal: controller.signal
    });

    const reader = response.body.pipeThrough(new TextDecoderStream()).getReader();
    let fullContent = '';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;

      const lines = value.split('\n');
      for (const line of lines) {
        if (!line.trim().startsWith('data:')) continue;
        const raw = line.trim().replace(/^data:\s*/, '');
        if (!raw || raw === '[DONE]') continue;
        
        try {
          const parsed = JSON.parse(raw);
          if (parsed.content) {
            fullContent += parsed.content;
            await typeWriter(aiMsg, fullContent);
          }
        } catch (e) {
          console.warn('JSON Parse Failed:', raw);
          continue;
        }
      }
    }
  } catch (err) {
    updateMessage(aiMsg, '出错了，请稍后重试。', true);
    console.error('stream error', err);
  } finally {
    sendBtn.disabled = false;
    controller = null;
  }
}

function createMessageElement(role, text) {
  const div = document.createElement('div');
  div.className = `message ${role}-message`;

  const header = document.createElement('div');
  header.className = 'message-header';
  header.innerHTML = `
    <strong>${role === 'user' ? '您' : 'AI助手'}</strong>
    <span class="timestamp">${new Date().toLocaleTimeString()}</span>
  `;

  const content = document.createElement('div');
  content.className = 'markdown-body';
  content.innerHTML = renderMarkdown(text);

  div.appendChild(header);
  div.appendChild(content);
  return div;
}

function updateMessage(element, content, isError = false) {
  const contentDiv = element.querySelector('.markdown-body');
  contentDiv.innerHTML = isError
    ? `<span style="color: #e53e3e;">${content}</span>`
    : renderMarkdown(content);
}

function renderMarkdown(text) {
  const rawHtml = marked.parse(text);
  return DOMPurify.sanitize(rawHtml);
}

function scrollToBottom() {
  requestAnimationFrame(() => {
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}

async function typeWriter(element, text) {
  const contentDiv = element.querySelector('.markdown-body');
  contentDiv.innerHTML = renderMarkdown(text);
}
</script>
</body>
</html>
