<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>HuengZing的助手</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.4.0/purify.min.js"></script>
  <style>
    body {
      background-color: #222;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      color: #fff;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    #chat-box {
      height: 60vh;
      overflow-y: auto;
      padding: 1rem;
      background: #333;
      border-radius: 8px;
      margin-bottom: 1rem;
    }
    button {
      background: #28a745;
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
    }
    button:hover {
      background: #218838;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    textarea, input {
      width: 100%;
      padding: 0.8rem;
      border: 2px solid #444;
      border-radius: 8px;
      margin-bottom: 1rem;
      background-color: #444;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="chat-container">
    <h1>HuengZing的助手</h1>
    <div id="chat-box"></div>
    <textarea id="user-input" placeholder="输入问题...(Shift+Enter换行)" onkeydown="handleKeydown(event)"></textarea>
    <button id="send-btn" onclick="sendMessage()">发送</button>
  </div>

  <script>
    let controller = null;

    async function sendMessage() {
      const input = document.getElementById('user-input');
      const question = input.value.trim();
      const sendBtn = document.getElementById('send-btn');
      const chatBox = document.getElementById('chat-box');

      if (!question) return;

      sendBtn.disabled = true;
      input.value = '';

      // 用户消息
      const userMsg = document.createElement('div');
      userMsg.classList.add('message', 'user-message');
      userMsg.innerHTML = `<strong>您:</strong><p>${question}</p>`;
      chatBox.appendChild(userMsg);

      // AI 消息框
      const aiMsg = document.createElement('div');
      aiMsg.classList.add('message', 'ai-message');
      aiMsg.innerHTML = '<strong>AI助手:</strong><p>思考中...</p>';
      chatBox.appendChild(aiMsg);

      // 滚动到底部
      chatBox.scrollTop = chatBox.scrollHeight;

      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

      try {
        const response = await fetch('/chat/stream/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
          },
          body: JSON.stringify({ question, model: 'v3' })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n\n');

          for (let line of lines.slice(0, -1)) {
            const data = JSON.parse(line.replace('data: ', ''));
            if (data.content) {
              aiMsg.querySelector('p').textContent = data.content;
              chatBox.scrollTop = chatBox.scrollHeight;
            }
          }
          buffer = lines[lines.length - 1];
        }
      } catch (error) {
        console.error(error);
        aiMsg.querySelector('p').textContent = '请求失败，请重试';
      } finally {
        sendBtn.disabled = false;
      }
    }

    function handleKeydown(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }
  </script>
</body>
</html>
